(function(){var g={}; var _ = _ || {}
var f=function(window){var Rx="Registering listeners",Sx="clpp.vimond.VimondPlugin",Tx=function(a,b,c,d,e){this.G=a;this.H=b;this.I=c;this.m=d;this.C=e;this.a=new _.Wh;this.l=!0;this.f=this.j=this.A=!1;this.B=null;this.h=new _.xl(this.Jh.bind(this));this.g=new _.K("clpp.vimond.VimondDispatcher");this.o=this.w=0;this.m&&this.a&&(this.g.debug(Rx),this.a.on(this.m,_.fg,this.Yk.bind(this)),this.a.on(this.m,_.qg,this.Zk.bind(this)),this.a.on(this.m,_.rc,this.Wk.bind(this)),this.a.on(this.m,_.sc,this.Xk.bind(this)))},Ux=function(a,
b){a.m.trigger(new _.L(_.Mg,{detail:b}))},Vx=function(a,b,c){b&&(a.A=!0,a.h.stop());a.m.onError(new _.O(b?_.P:1,9,9201,c))},Wx=function(a,b,c,d,e){this.l=a;this.o=c;this.h=b;this.a=d;this.j=e;this.g=new _.K("clpp.vimond.VimondService");this.f=0},Xx=function(a){this.m=a;this.a=new _.Wh;this.g=new _.K("clpp.vimond.VimondAdapter");this.f=this.h=!1;this.m&&this.a&&(this.g.debug(Rx),this.a.on(this.m,_.Of,this.o.bind(this)),this.a.on(this.m,_.rc,this.j.bind(this)),this.a.on(this.m,_.sc,this.l.bind(this)))},
Yx=function(a,b){var c=a.m.getState();if(1===b)return["str-start",_.xf];if(a.h)return[_.oe,_.hf];if(c===_.bq)return[_.oe,null];if(c===_.fq)return[_.qe,_.hf];var d=_.hf;if(c===_.$p||c===_.iq||a.f)d=_.xf;return["period",d]},Zx=function(){this.a=!1;this.g=new _.K(Sx);this.j=this.h=this.f=null},$x=function(){};_.u=Tx.prototype;_.u.Zk=function(){this.f||(this.f=1<Math.abs(this.w-this.m.getPosition()));this.w=this.m.getPosition()};_.u.Wk=function(){this.g.debug("Ad break started");this.j=!0};
_.u.Xk=function(){this.g.debug("Ad break stopped");this.j=!1};
_.u.Yk=function(a){var b=this,c,d,e,f,g;return _.I(function(h){if(1==h.a){c=a.detail;d=_.dq;e=c.currentState;f=c.previousState;b.g.debug("State changed, prev: "+f+" curr: "+e);if(b.A||b.j)return h["return"]();if(e===b.B&&!b.f)return b.g.debug("Ignore transition"),h["return"]();if(b.l&&e!==d.PLAYING)return h["return"]();if(b.f&&[d.PAUSED,d.BUFFERING].includes(e))return b.g.debug("Seeking"),h["return"]();b.f&&e===d.PLAYING&&(b.g.debug("Seeked"),b.f=!1);g=[d.PLAYING,d.PAUSED,d.ERROR,d.ENDED];if(!g.includes(e))return h.F(0);
b.B=e;return _.y(h,b.Jh(),3)}e===d.ENDED&&b.h.stop();_.B(h)})};
_.u.Jh=function(){var a=this,b,c,d,e,f,g;return _.I(function(h){if(1==h.a){var l=Math.floor(Date.now()/1E3);0<a.o&&a.g.debug("Last event was "+(l-a.o)+" seconds ago");a.o=l;a.h.stop();a.h.ca(a.l?10:a.G);a.l=!1;_.D(h,2);return _.y(h,a.C.fireEvent(),4)}if(2!=h.a)return b=h.f,Ux(a,b),_.sh(h,0);d=c=_.F(h);e=d.code;f=d.data;g=[1002,1003];g.includes(e)?(a.g.debug("Unreachable service"),Ux(a,f),Vx(a,a.H,f)):1001===e?(a.g.debug("Generic service error"),Ux(a,f),Vx(a,a.I,f)):a.g.error(c.toString());_.B(h)})};Wx.prototype.fireEvent=function(){this.f++;var a=_.N.qa(this.o);a.client.buildName=_.ta;a.client.buildVersion=_.ha;var b=a.client,c=this.a.m.getDrmInfo();b.drm=c?c.keySystem:"";a.client.pageUrl=document.location.href;a.client.streamUrl=this.a.m.getLoadedSource().url;a.client.userAgent=navigator.userAgent;a.client.videoFormat=this.a.m.getLoadedSource().type||"";b=a.client;c=this.a.m.getLoadedSource();c=((new _.Qk(c.url)).scheme||"").replace(":","");b.videoProtocol=c;b=Yx(this.a,this.f);a.client.playerEvent=
b[0]||"";a.client.playerState=b[1]||"";a.progress.vod&&(a.progress.vod.position=this.a.getPosition());if(b=a.progress.live){c=this.a;var d=c.m.getPresentationStartTime()||0;c=Math.floor(d+c.m.getPosition());c=(new Date(1E3*c)).toISOString();b.position=c;d=this.a;c=d.m.getPosition();d=d.m.getSeekRange().end;b.onLiveEdge=30>Math.abs(d-c);typeof b.liveResumePossible!==_.hd&&(b.liveResumePossible=!0)}a.progress.eventNumber=this.f;a.timestamp=(new Date).toISOString();this.g.debug("Fire an event");b=_.ek(this.l);
b.method=_.Fb;b.contentType="application/json";b.headers.Authorization="Bearer "+this.h;b.body=_.T.od(JSON.stringify(a));return this.j.fetch(b).T};Wx.prototype.Mg=function(a){this.h=a};Xx.prototype.getPosition=function(){return Math.floor(this.m.getPosition())};Xx.prototype.o=function(){this.h=!0};Xx.prototype.j=function(){this.f=!0};Xx.prototype.l=function(){this.f=!1};_.x(Zx,_.Gv);_.u=Zx.prototype;_.u.onPlayerCreated=function(){};
_.u.onContentWillLoad=function(a){var b=a.getConfiguration();(this.a=!_.N.R(b.vimond)&&typeof b.vimond===_.Xe)?a.namespace()===_.zd&&(this.a=!1,this.g.info("Vimond does not report when casting.")):this.g.debug("Vimond plugin is loaded but not configured. Will do nothing.");if(this.a){b=a.getConfiguration().vimond;for(var c=_.w(["authToken","playerEventRequest"]),d=c.next();!d.done;d=c.next())if(d=d.value,!b[d]){this.g.warn(d+" key is missing");a.onError(new _.O(1,9,9200));return}this.g.debug(_.ua);
c=b.failIfUnreachable;typeof c!==_.hd&&(c=!0);d=b.failOnError;typeof d!==_.hd&&(d=!0);this.f=new Xx(a);this.h=new Wx(b.playerEventRequest.uri,b.authToken,b.playerEventRequest.body,this.f,a.getNetworkEngine());this.j=new Tx(b.playerEventRequest.eventInterval,c,d,a,this.h)}};_.u.onPlayerWillRelease=function(){if(this.a){if(this.f){var a=this.f;a.g.debug(_.dc);_.Zh(a.a)}this.j&&(a=this.j,a.g.debug(_.dc),_.Zh(a.a),a.h.stop());this.j=this.h=this.f=null}};_.u.onPlayerWillDestroy=function(){};_.u.id=function(){return"vimond"};
_.u.Mg=function(a){this.a&&this.h&&this.h.Mg(a)};_.J(Sx,Zx);Zx.prototype.updateAuthToken=Zx.prototype.Mg;Zx.Id="vimond";$x.prototype.create=function(){return new Zx};_.gt(new $x);};
if(typeof(module)!="undefined"&&module.exports){var x=require("./cl.core.js");_ = x._;(f.call(g,this));module.exports=g;}
else if (typeof(define)!="undefined"&&define.amd) {define(["./cl.core"], function(c){_=c._;(f.call(g,this));return g;});}
else{_=this.clpp._;(f.call(g,this));}
})();