(function(){var g={}; var _ = _ || {}
var f=function(window){var EB="A persistent DRM session already exists for: ",FB="No DRM configuration.",GB="clpp.persistent",HB="clpp.persistent.SimpleSessionStorage",IB=function(a,b){for(var c=[],d=_.w(a),e=d.next();!e.done;e=d.next())c.push(b(e.value));return c},JB=function(a){a=a.h.keys();a=IB(a,function(b){return b.sessionId});return Array.from(a)},KB=function(a,b){var c,d,e;return _.I(function(f){if(1==f.a)return _.y(f,_.hp(a,b),2);c=f.f;if(!c)return a.g.debug("Ignoring attempt to remove missing session",b),f["return"]();
d=[];(e=a.h.get(c))&&a.C&&(e.nc=new _.mk,d.push(e.nc));a.g.debug("Attempting to remove session",b);d.push(c.remove());return f["return"](Promise.all(d))})},MB=function(a,b){a.L=LB;a.M=[];a.H=!0;return _.Lo(a,b)},OB=function(a,b,c,d,e,f){a.L=NB;var g=new Map,h=_.mp(b);g.set(h,{audioCapabilities:e,videoCapabilities:f,distinctiveIdentifier:_.ef,persistentState:_.Qf,sessionTypes:[_.kf],label:h,drmInfos:[{keySystem:b,licenseServerUri:c,distinctiveIdentifierRequired:!1,persistentStateRequired:!0,audioRobustness:"",
videoRobustness:"",serverCertificate:d,initData:null,keyIds:null}]});return _.Vo(a,g)},PB=function(){this.g=new _.K(HB)},QB=function(a){a=JSON.parse(a);var b=JSON.parse(a.sessionIds),c=a.audioCapabilities||[],d=a.videoCapabilities||[],e=a.serverCertificate||[],f=a.drmConfig||{};return{sessionIds:b,keySystem:a.keySystem,licenseServerUri:decodeURIComponent(a.licenseServerUri||""),serverCertificate:e?new Uint8Array(e):null,audioCapabilities:c,videoCapabilities:d,drmConfig:f}},RB=function(a,b){var c=
_.Zm(a),d=_.Em({drm:a});d.drm=a;var e=new _.Ho({tb:b,onError:function(){},hg:function(){},gg:function(){},onEvent:function(){},getConfiguration:function(){return d},dd:function(){return null}});e.f=c;return e},UB=function(a,b,c){var d,e,f,g,h,l,m,n,p;return _.I(function(q){switch(q.a){case 1:d=SB;e=TB;if(!a)return e.debug(FB),q["return"]();f=a.offlineId;return 0===f.length?q["return"]():_.y(q,d.get(f),2);case 2:if(g=q.f)return e.debug(EB,f),q["return"]();h=RB(a,c);_.D(q,3,4);return _.y(q,MB(h,b),
6);case 6:return _.y(q,_.ap(h),7);case 7:return _.y(q,_.bp(h),8);case 8:return l=h.getDrmInfo(),m=b.map(function(t){return{contentType:_.sl(t.video.mimeType,t.video.codecs),robustness:l.videoRobustness}}),n=JB(h),g={sessionIds:n,keySystem:l.keySystem,licenseServerUri:l.licenseServerUri,serverCertificate:l.serverCertificate,audioCapabilities:[],videoCapabilities:m,drmConfig:a},_.y(q,d.store(f,g),4);case 4:return _.th(q),_.y(q,h.destroy(),10);case 10:_.uh(q);break;case 3:throw p=_.F(q),e.error("Error while persisting DRM session "+
f),new _.O(1,6,6200,null,p);}})},VB=function(){this.g=new _.K(GB)},LB=1,NB=2;_.u=PB.prototype;
_.u.store=function(a,b){var c;return _.I(function(d){var e=JSON.stringify(b.sessionIds),f=b.serverCertificate?Array.from(b.serverCertificate):null;f=JSON.stringify(f);var g=JSON.stringify(b.audioCapabilities),h=JSON.stringify(b.videoCapabilities);c=JSON.stringify({sessionIds:e,keySystem:b.keySystem,licenseServerUri:encodeURIComponent(b.licenseServerUri),serverCertificate:f,audioCapabilities:g,videoCapabilities:h,drmConfig:JSON.stringify(b.drmConfig)});window.localStorage.setItem(encodeURIComponent(a),
btoa(c));_.B(d)})};_.u.get=function(a){var b=this,c;return _.I(function(d){if(c=window.localStorage.getItem(encodeURIComponent(a)))try{return d["return"](QB(atob(c)))}catch(e){b.g.warn("Error while loading offline items for "+a+" from storage: ",e)}return d["return"](null)})};_.u["delete"]=function(a){return _.I(function(b){window.localStorage.removeItem(encodeURIComponent(a));_.B(b)})};_.u.clear=function(){return _.I(function(a){window.localStorage.clear();_.B(a)})};_.u.getName=function(){return HB};_.J("clpp.persistent.useStorage",function(a){var b=["store","get","delete","clear","getName"];var c=[];_.N.R(a)||(_.N.Lb(a.store)||c.push("store"),_.N.Lb(a.get)||c.push("get"),_.N.Lb(a["delete"])||c.push("delete"),_.N.Lb(a.clear)||c.push("clear"),_.N.Lb(a.getName)||c.push("getName"),b=c);if(0<b.length)throw TB.warn("Invalid session storage implementation"),new _.O(1,6,6202,{missingMethods:b});SB=a});
_.J("clpp.persistent.fetchLicense",function(a,b,c){for(var d=[],e=2;e<arguments.length;++e)d[e-2]=arguments[e];var f,g,h,l,m,n,p,q,t,v,z,A,G,E,C,H,M,R,V;return _.I(function(S){switch(S.a){case 1:f=SB;g=TB;h=function(Ba,Ca){return new _.O(1,6,6200,Ba,Ca)};l=_.mq(a).shift();if(!l)throw h("No source specified.");if(!b)throw h(FB);m=b.offlineId;if(typeof m!==_.ig||!m.length)throw h("Missing offline id.");return _.y(S,f.get(m),2);case 2:if(n=S.f)return g.debug(EB,m),S["return"]();p=_.Em();q=new _.Ak;t=
[];v=_.w(d);for(z=v.next();!z.done;z=v.next())A=z.value,G=new A,_.Im(G.id())||(G.f(),_.Km(G),t.push(G));E=null;_.D(S,3,4);return _.y(S,_.Gu(l.url,q,p.manifest.attemptParameters,l.type||null),6);case 6:return E=S.f,E.configure(p.manifest),_.y(S,E.start(l.url,{configurationId:"",networkingEngine:q,filterAllPeriods:function(){},filterNewPeriod:function(){},onEvent:function(){},onError:function(){}}),7);case 7:C=S.f;if(!C.periods.length)throw h(null,new _.O(_.P,4,4014));H=_.xu(C.periods);return _.y(S,
UB(b,H,q),4);case 4:for(_.th(S);t.length;)M=t.shift(),M.a(),_.Hm["delete"](M.id());R=[];E&&R.push(E.stop());R.push(q.destroy());return _.y(S,Promise.all(R),9);case 9:_.uh(S);break;case 3:V=_.F(S);if(V instanceof _.O&&6200===V.code)throw V;throw h(null,V);}})});
_.J("clpp.persistent.removeLicense",function(a){var b,c,d,e,f,g,h;return _.I(function(l){switch(l.a){case 1:b=SB;c=TB;if(!_.N.da(a)||0===a.length)return c.warn("Invalid offlineId"),l["return"]();e=d=null;_.D(l,2,3);return _.y(l,b.get(a),5);case 5:f=l.f;if(!f)return c.debug("No persistent DRM session found"),l["return"]();f.drmConfig.delayLicenseRequestUntilPlayed=!0;e=new _.Ak;d=RB(f.drmConfig,e);return _.y(l,OB(d,f.keySystem,f.licenseServerUri,f.serverCertificate,f.audioCapabilities,f.videoCapabilities),
6);case 6:return _.y(l,_.ap(d),7);case 7:return _.y(l,Promise.all(f.sessionIds.map(function(m){return _.I(function(n){if(1==n.a)return _.y(n,KB(d,m),2);c.debug("successfully removed session with id",m);_.B(n)})})),8);case 8:return _.y(l,b["delete"](a),3);case 3:return _.th(l),g=[],d&&g.push(d.destroy()),e&&g.push(e.destroy()),_.y(l,Promise.all(g),10);case 10:_.uh(l);break;case 2:throw h=_.F(l),c.error("Failed to remove session"),new _.O(1,6,6201,null,h);}})});var SB=new PB,TB=new _.K(GB);_.x(VB,_.Kt);VB.prototype.id=function(){return _.jf};VB.prototype.l=function(a,b){var c=this,d,e,f;return _.I(function(g){if(1==g.a){d=a.getConfiguration().drm;if(!d)return c.g.debug("No DRM configuration found for loaded source."),g["return"]();c.g.debug("Persisting DRM session ID: "+d.offlineId);e=a.getNetworkEngine();_.D(g,2);return _.y(g,UB(d,b,e),4)}if(2!=g.a)return a.trigger(new _.L(_.he,{offlineId:d.offlineId})),_.sh(g,0);f=_.F(g);a.onError(f);_.B(g)})};
VB.prototype.j=function(a){var b=this,c,d;return _.I(function(e){if(1==e.a)return b.g.debug("Getting EME session IDs for "+a),c=SB,_.D(e,2),_.y(e,c.get(a),4);if(2!=e.a){if(d=e.f)return e["return"](d.sessionIds||[]);b.g.debug("No offline session found for "+a);return e["return"]([])}_.F(e);b.g.warn("Error while loading session info from storage");return e["return"]([])})};_.J("clpp.persistent.PersistentLicenseComponent",VB);};
if(typeof(module)!="undefined"&&module.exports){var x=require("./cl.core.js");_ = x._;(f.call(g,this));module.exports=g;}
else if (typeof(define)!="undefined"&&define.amd) {define(["./cl.core"], function(c){_=c._;(f.call(g,this));return g;});}
else{_=this.clpp._;(f.call(g,this));}
})();