(function(){var g={}; var _ = _ || {}
var f=function(window){var mB="A persistent DRM session already exists for: ",nB="No DRM configuration.",oB="clpp.persistent",pB="clpp.persistent.SimpleSessionStorage",qB=function(a,b){for(var c=[],d=_.w(a),e=d.next();!e.done;e=d.next())c.push(b(e.value));return c},rB=function(a){a=a.f.keys();a=qB(a,function(b){return b.sessionId});return Array.from(a)},sB=function(a,b){var c,d,e;return _.I(function(f){if(1==f.a)return _.y(f,_.Yo(a,b),2);c=f.f;if(!c)return a.g.debug("Ignoring attempt to remove missing session",b),f["return"]();
d=[];(e=a.f.get(c))&&a.B&&(e.Lb=new _.gk,d.push(e.Lb));a.g.debug("Attempting to remove session",b);d.push(c.remove());return f["return"](Promise.all(d))})},uB=function(a,b){a.K=tB;a.L=[];a.G=!0;return _.Bo(a,b)},wB=function(a,b,c,d,e,f){a.K=vB;var g=new Map,h=_.cp(b);g.set(h,{audioCapabilities:e,videoCapabilities:f,distinctiveIdentifier:_.af,persistentState:_.Nf,sessionTypes:[_.ff],label:h,drmInfos:[{keySystem:b,licenseServerUri:c,distinctiveIdentifierRequired:!1,persistentStateRequired:!0,audioRobustness:"",
videoRobustness:"",serverCertificate:d,initData:null,keyIds:null}]});return _.Lo(a,g)},xB=function(){this.g=new _.K(pB)},yB=function(a){a=JSON.parse(a);var b=JSON.parse(a.sessionIds),c=a.audioCapabilities||[],d=a.videoCapabilities||[],e=a.serverCertificate||[],f=a.drmConfig||{};return{sessionIds:b,keySystem:a.keySystem,licenseServerUri:decodeURIComponent(a.licenseServerUri||""),serverCertificate:e?new Uint8Array(e):null,audioCapabilities:c,videoCapabilities:d,drmConfig:f}},zB=function(a,b){var c=
_.Rm(a),d=_.vm({drm:a});d.drm=a;var e=new _.xo({Jb:b,onError:function(){},Yf:function(){},Xf:function(){},onEvent:function(){},getConfiguration:function(){return d},$c:function(){return null}});e.h=c;return e},CB=function(a,b,c){var d,e,f,g,h,l,m,n,p;return _.I(function(q){switch(q.a){case 1:d=AB;e=BB;if(!a)return e.debug(nB),q["return"]();f=a.offlineId;return 0===f.length?q["return"]():_.y(q,d.get(f),2);case 2:if(g=q.f)return e.debug(mB,f),q["return"]();h=zB(a,c);_.D(q,3,4);return _.y(q,uB(h,b),
6);case 6:return _.y(q,_.Ro(h),7);case 7:return _.y(q,_.So(h),8);case 8:return l=h.getDrmInfo(),m=b.map(function(t){return{contentType:_.kl(t.video.mimeType,t.video.codecs),robustness:l.videoRobustness}}),n=rB(h),g={sessionIds:n,keySystem:l.keySystem,licenseServerUri:l.licenseServerUri,serverCertificate:l.serverCertificate,audioCapabilities:[],videoCapabilities:m,drmConfig:a},_.y(q,d.store(f,g),4);case 4:return _.ph(q),_.y(q,h.destroy(),10);case 10:_.qh(q);break;case 3:throw p=_.E(q),e.error("Error while persisting DRM session "+
f),new _.N(1,6,6200,null,p);}})},DB=function(){this.g=new _.K(oB)},tB=1,vB=2;_.u=xB.prototype;
_.u.store=function(a,b){var c;return _.I(function(d){var e=JSON.stringify(b.sessionIds),f=b.serverCertificate?Array.from(b.serverCertificate):null;f=JSON.stringify(f);var g=JSON.stringify(b.audioCapabilities),h=JSON.stringify(b.videoCapabilities);c=JSON.stringify({sessionIds:e,keySystem:b.keySystem,licenseServerUri:encodeURIComponent(b.licenseServerUri),serverCertificate:f,audioCapabilities:g,videoCapabilities:h,drmConfig:JSON.stringify(b.drmConfig)});window.localStorage.setItem(encodeURIComponent(a),
btoa(c));_.A(d)})};_.u.get=function(a){var b=this,c;return _.I(function(d){if(c=window.localStorage.getItem(encodeURIComponent(a)))try{return d["return"](yB(atob(c)))}catch(e){b.g.warn("Error while loading offline items for "+a+" from storage: ",e)}return d["return"](null)})};_.u["delete"]=function(a){return _.I(function(b){window.localStorage.removeItem(encodeURIComponent(a));_.A(b)})};_.u.clear=function(){return _.I(function(a){window.localStorage.clear();_.A(a)})};_.u.getName=function(){return pB};_.J("clpp.persistent.useStorage",function(a){var b=["store","get","delete","clear","getName"];var c=[];_.M.R(a)||(_.M.Ib(a.store)||c.push("store"),_.M.Ib(a.get)||c.push("get"),_.M.Ib(a["delete"])||c.push("delete"),_.M.Ib(a.clear)||c.push("clear"),_.M.Ib(a.getName)||c.push("getName"),b=c);if(0<b.length)throw BB.warn("Invalid session storage implementation"),new _.N(1,6,6202,{missingMethods:b});AB=a});
_.J("clpp.persistent.fetchLicense",function(a,b,c){for(var d=[],e=2;e<arguments.length;++e)d[e-2]=arguments[e];var f,g,h,l,m,n,p,q,t,v,z,C,F,G,B,H,O,T,da;return _.I(function(aa){switch(aa.a){case 1:f=AB;g=BB;h=function(ya,Va){return new _.N(1,6,6200,ya,Va)};l=_.Yp(a).shift();if(!l)throw h("No source specified.");if(!b)throw h(nB);m=b.offlineId;if(typeof m!==_.fg||!m.length)throw h("Missing offline id.");return _.y(aa,f.get(m),2);case 2:if(n=aa.f)return g.debug(mB,m),aa["return"]();p=_.vm();q=new _.tk;
t=[];v=_.w(d);for(z=v.next();!z.done;z=v.next())C=z.value,F=new C,_.zm(F.id())||(F.f(),_.Bm(F),t.push(F));G=null;_.D(aa,3,4);return _.y(aa,_.pu(l.url,q,p.manifest.attemptParameters,l.type||null),6);case 6:return G=aa.f,G.configure(p.manifest),_.y(aa,G.start(l.url,{configurationId:"",networkingEngine:q,filterAllPeriods:function(){},filterNewPeriod:function(){},onEvent:function(){},onError:function(){}}),7);case 7:B=aa.f;if(!B.periods.length)throw h(null,new _.N(_.P,4,4014));H=_.gu(B.periods);return _.y(aa,
CB(b,H,q),4);case 4:for(_.ph(aa);t.length;)O=t.shift(),O.a(),_.ym["delete"](O.id());T=[];G&&T.push(G.stop());T.push(q.destroy());return _.y(aa,Promise.all(T),9);case 9:_.qh(aa);break;case 3:da=_.E(aa);if(da instanceof _.N&&6200===da.code)throw da;throw h(null,da);}})});
_.J("clpp.persistent.removeLicense",function(a){var b,c,d,e,f,g,h;return _.I(function(l){switch(l.a){case 1:b=AB;c=BB;if(!_.M.da(a)||0===a.length)return c.warn("Invalid offlineId"),l["return"]();e=d=null;_.D(l,2,3);return _.y(l,b.get(a),5);case 5:f=l.f;if(!f)return c.debug("No persistent DRM session found"),l["return"]();f.drmConfig.delayLicenseRequestUntilPlayed=!0;e=new _.tk;d=zB(f.drmConfig,e);return _.y(l,wB(d,f.keySystem,f.licenseServerUri,f.serverCertificate,f.audioCapabilities,f.videoCapabilities),
6);case 6:return _.y(l,_.Ro(d),7);case 7:return _.y(l,Promise.all(f.sessionIds.map(function(m){return _.I(function(n){if(1==n.a)return _.y(n,sB(d,m),2);c.debug("successfully removed session with id",m);_.A(n)})})),8);case 8:return _.y(l,b["delete"](a),3);case 3:return _.ph(l),g=[],d&&g.push(d.destroy()),e&&g.push(e.destroy()),_.y(l,Promise.all(g),10);case 10:_.qh(l);break;case 2:throw h=_.E(l),c.error("Failed to remove session"),new _.N(1,6,6201,null,h);}})});var AB=new xB,BB=new _.K(oB);_.x(DB,_.tt);DB.prototype.id=function(){return _.ef};DB.prototype.l=function(a,b){var c=this,d,e,f;return _.I(function(g){if(1==g.a){d=a.getConfiguration().drm;if(!d)return c.g.debug("No DRM configuration found for loaded source."),g["return"]();c.g.debug("Persisting DRM session ID: "+d.offlineId);e=a.getNetworkEngine();_.D(g,2);return _.y(g,CB(d,b,e),4)}if(2!=g.a)return a.trigger(new _.L(_.ee,{offlineId:d.offlineId})),_.oh(g,0);f=_.E(g);a.onError(f);_.A(g)})};
DB.prototype.j=function(a){var b=this,c,d;return _.I(function(e){if(1==e.a)return b.g.debug("Getting EME session IDs for "+a),c=AB,_.D(e,2),_.y(e,c.get(a),4);if(2!=e.a){if(d=e.f)return e["return"](d.sessionIds||[]);b.g.debug("No offline session found for "+a);return e["return"]([])}_.E(e);b.g.warn("Error while loading session info from storage");return e["return"]([])})};_.J("clpp.persistent.PersistentLicenseComponent",DB);};
if(typeof(module)!="undefined"&&module.exports){var x=require("./cl.core.js");_ = x._;(f.call(g,this));module.exports=g;}
else if (typeof(define)!="undefined"&&define.amd) {define(["./cl.core"], function(c){_=c._;(f.call(g,this));return g;});}
else{_=this.clpp._;(f.call(g,this));}
})();